{"version":3,"file":"_drawLegend.js","sources":["../../src/_drawLegend.js"],"sourcesContent":["import {nest} from \"d3-collection\";\nimport {configPrep, elem, merge} from \"d3plus-common\";\n\n/**\n    @function legendLabel\n    @desc Default label function for the legend.\n    @private\n*/\nexport function legendLabel(d, i) {\n  const l = this._drawLabel(d, i);\n  return l instanceof Array ? l.join(\", \") : l;\n}\n\n/**\n    @function _drawLegend\n    @desc Renders the legend if this._legend is not falsy.\n    @param {Array} data The filtered data array to be displayed.\n    @private\n*/\nexport default function(data = []) {\n\n  if (this._legend) {\n\n    const legendBounds = this._legendClass.outerBounds();\n    const position = this._legendPosition;\n    const wide = [\"top\", \"bottom\"].includes(position);\n\n    const transform = {transform: `translate(${wide ? this._margin.left + this._padding.left : this._margin.left}, ${wide ? this._margin.top : this._margin.top + this._padding.top})`};\n\n    const legendGroup = elem(\"g.d3plus-viz-legend\", {\n      condition: this._legend && !this._legendConfig.select,\n      enter: transform,\n      parent: this._select,\n      transition: this._transition,\n      update: transform\n    }).node();\n\n    const legendData = [];\n\n    const color = (d, i) => {\n      const shape = this._shape(d, i);\n      const attr = shape === \"Line\" ? \"stroke\" : \"fill\";\n      const value = this._shapeConfig[shape] && this._shapeConfig[shape][attr]\n        ? this._shapeConfig[shape][attr] : this._shapeConfig[attr];\n      return typeof value === \"function\" ? value(d, i) : value;\n    };\n\n    const opacity = (d, i) => {\n      const shape = this._shape(d, i);\n      const value = this._shapeConfig[shape] && this._shapeConfig[shape].opacity\n        ? this._shapeConfig[shape].opacity : this._shapeConfig.opacity;\n      return typeof value === \"function\" ? value(d, i) : value;\n    };\n\n    const fill = (d, i) => `${ color(d, i) }_${ opacity(d, i) }`;\n\n    nest()\n      .key(fill)\n      .rollup(leaves => legendData.push(merge(leaves, this._aggs)))\n      .entries(this._colorScale ? data.filter((d, i) => this._colorScale(d, i) === undefined) : data);\n\n    const hidden = (d, i) => {\n      let id = this._id(d, i);\n      if (id instanceof Array) id = id[0];\n      return this._hidden.includes(id) || this._solo.length && !this._solo.includes(id);\n    };\n\n    this._legendClass\n      .id(fill)\n      .align(wide ? \"center\" : position)\n      .direction(wide ? \"row\" : \"column\")\n      .duration(this._duration)\n      .data(legendData.length > 1 || this._colorScale ? legendData : [])\n      .height(wide ? this._height - (this._margin.bottom + this._margin.top) : this._height - (this._margin.bottom + this._margin.top + this._padding.bottom + this._padding.top))\n      .select(legendGroup)\n      .verticalAlign(!wide ? \"middle\" : position)\n      .width(wide ? this._width - (this._margin.left + this._margin.right + this._padding.left + this._padding.right) : this._width - (this._margin.left + this._margin.right))\n      .shapeConfig(configPrep.bind(this)(this._shapeConfig, \"legend\"))\n      .config(this._legendConfig)\n      .shapeConfig({\n        fill: (d, i) => hidden(d, i) ? this._hiddenColor(d, i) : color(d, i),\n        labelConfig: {\n          fontOpacity: (d, i) => hidden(d, i) ? this._hiddenOpacity(d, i) : 1\n        },\n        opacity\n      })\n      .render();\n\n    if (!this._legendConfig.select && legendBounds.height) {\n      if (wide) this._margin[position] += legendBounds.height + this._legendClass.padding() * 2;\n      else this._margin[position] += legendBounds.width + this._legendClass.padding() * 2;\n    }\n  }\n}\n"],"names":["const","this","let"],"mappings":"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"}